frontend api_gateway
    bind *:80
    mode http
    option http-server-close
    option forwardfor
    acl is_login_path path_beg /api/v1/login
    acl is_signup_path path_beg /api/v1/signup
    use_backend user_backend if is_login_path
    use_backend user_backend if is_signup_path
    acl is_images_path path_beg /api/v1/images
    acl is_upload_path path_beg /api/v1/upload
    acl is_download_path path_beg /api/v1/download
    use_backend image_backend if is_images_path
    use_backend image_backend if is_upload_path
    use_backend image_backend if is_download_path

backend user_backend
    mode http
    option http-server-close
    option forwardfor
    server v1_server user_service:23450
    reqrep ^([^\ :]*)\ /api/v1/login(.*) \1\ /login\2
    reqrep ^([^\ :]*)\ /api/v1/signup(.*) \1\ /signup\2

backend image_backend
    mode http
    option http-server-close
    option forwardfor
    server v1_server image_service:23451
    reqrep ^([^\ :]*)\ /api/v1/images(.*) \1\ /images\2
    reqrep ^([^\ :]*)\ /api/v1/upload(.*) \1\ /upload\2
    reqrep ^([^\ :]*)\ /api/v1/download(.*) \1\ /download\2